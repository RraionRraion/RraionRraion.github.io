---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import { defaultMeetings } from '../data/meetings';
import { Image } from 'astro:assets';
import VpmCode from '../assets/vpm.png';
import ShipLogo from '../assets/shiplogo.jpg';
import ToastmastersLogo from '../assets/toastmasters.png';
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`${SITE_TITLE} | Console`} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main class="console-page">
			<section class="console-wrap">
				<div id="login-panel" class="panel">
					<h1>SHIP Console</h1>
					<p>Login to manage meetings.</p>
					<form id="login-form">
						<label>Account <input id="account" type="text" autocomplete="username" required /></label>
						<label>Password <input id="password" type="password" autocomplete="current-password" required /></label>
						<button type="submit">Login</button>
					</form>
				</div>

				<div id="app-panel" class="panel hidden">
					<div class="app-head">
						<h1>Meeting Admin</h1>
						<div class="app-actions">
							<button id="new-meeting" type="button">New Meeting</button>
							<button id="logout" type="button">Logout</button>
							<button id="print-agenda" type="button">Print</button>
						</div>
					</div>

					<div class="layout">
						<section>
							<h2>Meetings</h2>
							<div id="meeting-list" class="list"></div>
						</section>

						<section>
							<h2>Editor</h2>
							<form id="meeting-form" class="editor-form">
								<label class="editor-field">
									<span class="editor-label">Meeting ID</span>
									<input name="id" placeholder="#442" required />
								</label>
								<label class="editor-field">
									<span class="editor-label">Type</span>
									<select name="type" required>
										<option value="Regular">Regular</option>
										<option value="Regular English">Regular English</option>
										<option value="Regular Chinese">Regular Chinese</option>
										<option value="Joint">Joint</option>
									</select>
								</label>
								<label class="editor-field">
									<span class="editor-label">Title</span>
									<input name="title" placeholder="Title" required />
								</label>
								<label class="editor-field">
									<span class="editor-label">Word of Today</span>
									<input name="wordOfToday" placeholder="Today's word" />
								</label>
								<label class="editor-field">
									<span class="editor-label">Manager</span>
									<input name="manager" placeholder="Manager" required />
								</label>
								<label class="editor-field">
									<span class="editor-label">Date</span>
									<input name="date" type="date" required />
								</label>
								<label class="editor-field">
									<span class="editor-label">Time</span>
									<select id="meeting-time-select" name="time" required>
										<option value="19:30:00 - 21:30:00">19:30:00 - 21:30:00</option>
										<option value="19:15:00 - 21:30:00">19:15:00 - 21:30:00</option>
										<option value="19:00:00 - 21:00:00">19:00:00 - 21:00:00</option>
										<option value="20:00:00 - 22:00:00">20:00:00 - 22:00:00</option>
									</select>
								</label>
								<label class="editor-field">
									<span class="editor-label">Location</span>
									<input name="location" placeholder="Location" value="深圳湾科技生态园10B号楼" required />
								</label>
								<label class="editor-field">
									<span class="editor-label">Image</span>
									<input name="image" placeholder="Image URL or Base64" />
								</label>
								<label class="editor-field">
									<span class="editor-label">Description</span>
									<textarea name="description" placeholder="Description" rows="4" required></textarea>
								</label>
								<label class="editor-field file-label">
									<span class="editor-label">Upload</span>
									<input id="image-file" type="file" accept="image/*" />
								</label>

								<div class="sub-block">
									<div class="sub-head">
										<h3>Awards</h3>
									</div>
									<div id="award-list"></div>
								</div>

								<div class="sub-block">
									<div class="sub-head">
										<h3>Agenda</h3>
										<div class="agenda-tools">
											<label class="start-time-label">
												Start
												<input id="agenda-start-time" type="time" value="19:00" />
											</label>
											<button id="load-template" type="button">Load Standard Template</button>
											<button id="add-agenda" type="button">+ Agenda Item</button>
										</div>
									</div>
									<div class="agenda-head">
										<span>Plan time</span>
										<span>Duration (min)</span>
										<span>Agenda title</span>
										<span>Role taker</span>
										<span>Actual duration</span>
										<span>Signal</span>
										<span></span>
									</div>
									<div id="agenda-list"></div>
								</div>

								<div class="form-actions">
									<button type="submit">Save</button>
									<button id="delete-meeting" type="button">Delete</button>
								</div>
							</form>
						</section>
					</div>
				</div>
			</section>
		</main>
		<Footer />

		<script is:inline define:vars={{ defaultMeetings, vpmCode: VpmCode.src, shipLogo: ShipLogo.src, toastmastersLogo: ToastmastersLogo.src }}>
			const DEFAULT_MEETINGS = Array.isArray(defaultMeetings) ? defaultMeetings : [];
			const STORAGE_KEY = 'ship_meetings_v1';
			const AUTH_KEY = 'ship_console_auth';
			const ACCOUNT = 'ship';
			const PASSWORD = 'ship';
			const DEFAULT_TYPE = 'Regular';
			const DEFAULT_TIME_RANGE = '19:30:00 - 21:30:00';
			const DEFAULT_LOCATION = '深圳湾科技生态园10B号楼';
			const STANDARD_TEMPLATE = [
				{ duration: '1', title: 'Welcome and meeting rules', speaker: 'Horatio' },
				{ duration: '2', title: 'Opening', speaker: 'Gianna' },
				{ duration: '1', title: 'Toastmaster of the Evening', speaker: 'Nico' },
				{ duration: '1', title: 'Timer Introduction', speaker: 'Bubbles' },
				{ duration: '1', title: 'Grammarian Introduction', speaker: 'Leta' },
				{ duration: '1', title: 'Hark master Introduction', speaker: 'Dustin' },
				{ duration: '7', title: 'IP 3-1 the translator', speaker: 'Nico' },
				{ duration: '7', title: 'PM 4-1 My "Unofficial" Story', speaker: 'Sophie' },
				{ duration: '3', title: 'Speech by Mark', speaker: 'Mark' },
				{ duration: '5', title: 'Guest Introduction', speaker: 'Rraion' },
				{ duration: '3', title: 'Camera Flow Program', speaker: 'Angela' },
				{ duration: '10', title: 'Break', speaker: 'All' },
				{ duration: '25', title: 'Table Topic: Sense of Ritual or Formalism', speaker: 'Gianna' },
				{ duration: '3', title: "Evaluation to Nico", speaker: 'Bella' },
				{ duration: '3', title: "Evaluation to Sophie", speaker: 'Portia' },
				{ duration: '3', title: 'Evaluation to Mark', speaker: 'Charmni' },
				{ duration: '7', title: 'Table Topic Evaluation', speaker: 'Jurgen' },
				{ duration: '2', title: 'Grammarian Report', speaker: 'Leta' },
				{ duration: '3', title: 'Hark master Report', speaker: 'Dustin' },
				{ duration: '2', title: 'Timer Report', speaker: 'Bubbles' },
				{ duration: '1', title: 'Vote for the best', speaker: 'All' },
				{ duration: '8', title: 'Moment of truth', speaker: 'Horatio' },
				{ duration: '2', title: 'Award ceremony', speaker: 'Angela' },
				{ duration: '1', title: 'Closing', speaker: 'Gianna' },
			];
			const FIXED_AWARD_TITLES = [
				'Best Master',
				'Best Meeting Manager',
				'Best Table Topic Speaker',
				'Best Evaluator',
				'Best Speaker',
				'Best Facilitator',
			];

			const qs = (s) => document.querySelector(s);
			const byId = (s) => document.getElementById(s);

			let meetings = [];
			let editingIndex = null;

				function loadMeetings() {
					try {
						const raw = localStorage.getItem(STORAGE_KEY);
						meetings = raw ? JSON.parse(raw) : DEFAULT_MEETINGS;
						if (!Array.isArray(meetings)) meetings = DEFAULT_MEETINGS;
					} catch (err) {
						meetings = DEFAULT_MEETINGS;
					}
				}

			function saveMeetings() {
				localStorage.setItem(STORAGE_KEY, JSON.stringify(meetings));
				renderMeetingList();
			}

			function isAuth() {
				return sessionStorage.getItem(AUTH_KEY) === '1';
			}

			function setAuth(ok) {
				if (ok) sessionStorage.setItem(AUTH_KEY, '1');
				else sessionStorage.removeItem(AUTH_KEY);
			}

			function setView() {
				byId('login-panel').classList.toggle('hidden', isAuth());
				byId('app-panel').classList.toggle('hidden', !isAuth());
			}

			function makeAwardRow(data = { title: '', winner: '' }) {
				const row = document.createElement('div');
				row.className = 'row award-row';
				row.dataset.awardTitle = String(data.title || '');
				row.innerHTML = `
					<input name="awardTitle" value="${data.title || ''}" readonly />
					<input name="awardWinner" placeholder="Winner" value="${data.winner || ''}" />
				`;
				return row;
			}

			function renderAwardRows(awards = []) {
				const titleToWinner = new Map();
				awards.forEach((a) => {
					const key = String(a?.title || '').trim().toLowerCase();
					if (key && !titleToWinner.has(key)) titleToWinner.set(key, String(a?.winner || '').trim());
				});
				byId('award-list').innerHTML = '';
				FIXED_AWARD_TITLES.forEach((title, idx) => {
					const winnerByTitle = titleToWinner.get(title.toLowerCase());
					const winnerByIndex = awards[idx] ? String(awards[idx].winner || '').trim() : '';
					byId('award-list').appendChild(makeAwardRow({ title, winner: winnerByTitle ?? winnerByIndex }));
				});
			}

			function parseMinutes(text) {
				const m = String(text || '').match(/(\d+)/);
				return m ? Number(m[1]) : NaN;
			}

			function timeToMinutes(hhmm) {
				const m = String(hhmm || '').trim().match(/^(\d{1,2}):(\d{2})$/);
				if (!m) return NaN;
				return Number(m[1]) * 60 + Number(m[2]);
			}

			function minutesToTime(total) {
				if (!Number.isFinite(total)) return '';
				const fixed = ((total % 1440) + 1440) % 1440;
				const h = String(Math.floor(fixed / 60)).padStart(2, '0');
				const m = String(fixed % 60).padStart(2, '0');
				return `${h}:${m}`;
			}

			function toIsoDate(date) {
				const y = date.getFullYear();
				const m = String(date.getMonth() + 1).padStart(2, '0');
				const d = String(date.getDate()).padStart(2, '0');
				return `${y}-${m}-${d}`;
			}

			function ensureSelectHasValue(selectEl, value) {
				const text = String(value || '').trim();
				if (!selectEl || !text) return;
				const has = [...selectEl.options].some((opt) => opt.value === text);
				if (!has) {
					const option = document.createElement('option');
					option.value = text;
					option.textContent = text;
					selectEl.appendChild(option);
				}
			}

			function parseActualRange(value) {
					const raw = String(value || '').replaceAll('—', '-').replaceAll('–', '-').trim();
					const pureMinutes = raw.match(/^\d+$/);
					if (pureMinutes) {
						const mins = Number(pureMinutes[0]);
						return Number.isFinite(mins) ? { start: 0, end: mins } : null;
					}
					const parts = raw.split('-').map((p) => p.trim()).filter(Boolean);
					if (parts.length >= 2) {
						const start = timeToMinutes(parts[0]);
						const end = timeToMinutes(parts[1]);
						if (Number.isFinite(start) && Number.isFinite(end)) {
							return { start, end: end < start ? end + 24 * 60 : end };
						}
					}
					if (parts.length === 1) {
						const only = timeToMinutes(parts[0]);
						if (Number.isFinite(only)) return { start: only, end: only };
					}
					return null;
				}

			function getStatusClass(actualTime, duration) {
				const range = parseActualRange(actualTime);
				const dur = parseMinutes(duration);
				if (!range || !Number.isFinite(dur) || dur <= 0) return 'status-neutral';
				const actualDur = range.end - range.start;
				return actualDur <= dur ? 'status-green' : 'status-red';
			}

			function recomputeAgendaPlanTimes() {
				const rows = [...byId('agenda-list').querySelectorAll('.agenda-row')];
				let nextPlan = timeToMinutes(byId('agenda-start-time').value);
				if (!Number.isFinite(nextPlan)) nextPlan = timeToMinutes('19:00');
				nextPlan += 30;

				rows.forEach((row, idx) => {
					const planInput = row.querySelector('[name="planTimeDisplay"]');
					const durationInput = row.querySelector('[name="agendaDuration"]');
					const actualInput = row.querySelector('[name="actualTime"]');
					const status = row.querySelector('.status-pill');

					if (idx === 0) {
						planInput.value = minutesToTime(nextPlan);
					} else {
						const prevRow = rows[idx - 1];
						const prevDuration = prevRow.querySelector('[name="agendaDuration"]').value;
						const prevPlan = prevRow.querySelector('[name="planTimeDisplay"]').value;
						const prevDur = parseMinutes(prevDuration);
						const prevPlanMin = timeToMinutes(prevPlan);
						if (Number.isFinite(prevPlanMin)) {
							nextPlan = prevPlanMin + (Number.isFinite(prevDur) ? prevDur : 0) + 1;
						}
						planInput.value = minutesToTime(nextPlan);
					}

					const statusClass = getStatusClass(actualInput.value, durationInput.value);
					status.className = `status-pill ${statusClass}`;
					status.textContent = '';
					status.title =
						statusClass === 'status-green'
							? 'On time'
							: statusClass === 'status-red'
								? 'Over time'
								: 'Waiting actual time';
				});
			}

			function makeAgendaRow(data = { duration: '', actualTime: '', title: '', speaker: '' }) {
				const row = document.createElement('div');
				row.className = 'row agenda-row';
				row.innerHTML = `
					<input name="planTimeDisplay" placeholder="Auto" readonly />
					<input name="agendaDuration" placeholder="2" value="${data.duration || data.planDuration || ''}" />
					<input name="agendaTitle" placeholder="Agenda title" value="${data.title || ''}" />
					<input name="agendaSpeaker" placeholder="Speaker" value="${data.speaker || ''}" />
					<input name="actualTime" placeholder="Actual duration" value="${data.actualTime || ''}" />
					<span class="status-pill status-neutral" title="Status preview"></span>
					<button type="button" class="remove">x</button>
				`;
				row.querySelector('.remove').addEventListener('click', () => {
					row.remove();
					recomputeAgendaPlanTimes();
				});
				row.querySelector('[name="agendaDuration"]').addEventListener('input', recomputeAgendaPlanTimes);
				row.querySelector('[name="actualTime"]').addEventListener('input', recomputeAgendaPlanTimes);
				return row;
			}

				function bindFileUpload() {
					byId('image-file').addEventListener('change', (evt) => {
						const target = evt.target;
						const files = target && target.files ? target.files : null;
						const file = files && files.length ? files[0] : null;
						if (!file) return;
						const reader = new FileReader();
					reader.onload = () => {
						const input = qs('[name="image"]');
						input.value = String(reader.result || '');
					};
					reader.readAsDataURL(file);
				});
			}

			function renderMeetingList() {
				const list = byId('meeting-list');
				list.innerHTML = meetings
					.map(
						(item, idx) => `
							<button type="button" class="meeting-item ${idx === editingIndex ? 'active' : ''}" data-idx="${idx}">
								<strong>${item.id}</strong>
								<span>${item.title}</span>
								<small>${item.date}</small>
							</button>
						`
					)
					.join('');
				list.querySelectorAll('[data-idx]').forEach((btn) => {
					btn.addEventListener('click', () => loadToForm(Number(btn.dataset.idx)));
				});
			}

			function clearRows() {
				byId('award-list').innerHTML = '';
				byId('agenda-list').innerHTML = '';
			}

			function loadToForm(idx) {
				const form = byId('meeting-form');
				const item = meetings[idx];
				if (!item) return;
				editingIndex = idx;
				['id', 'title', 'wordOfToday', 'manager', 'location', 'description', 'image'].forEach((k) => {
					form.elements[k].value = item[k] || '';
				});
				form.elements.date.value = item.date || toIsoDate(new Date());
				ensureSelectHasValue(form.elements.type, item.type);
				form.elements.type.value = item.type || DEFAULT_TYPE;
				ensureSelectHasValue(form.elements.time, item.time);
				form.elements.time.value = item.time || DEFAULT_TIME_RANGE;
				byId('agenda-start-time').value = item.agendaStartTime || '19:00';
				clearRows();
				renderAwardRows(item.awards || []);
				(item.agenda || []).forEach((a) => byId('agenda-list').appendChild(makeAgendaRow(a)));
				recomputeAgendaPlanTimes();
				renderMeetingList();
			}

			function newMeeting() {
				editingIndex = null;
				const form = byId('meeting-form');
				form.reset();
				form.elements.date.value = toIsoDate(new Date());
				form.elements.type.value = DEFAULT_TYPE;
				form.elements.time.value = DEFAULT_TIME_RANGE;
				form.elements.location.value = DEFAULT_LOCATION;
				byId('agenda-start-time').value = '19:00';
				clearRows();
				renderAwardRows();
				byId('agenda-list').appendChild(makeAgendaRow());
				recomputeAgendaPlanTimes();
				renderMeetingList();
			}

			function collectForm() {
				const form = byId('meeting-form');
				const awards = [...byId('award-list').querySelectorAll('.row')].map((row) => ({
					title: (row.dataset.awardTitle || row.querySelector('[name="awardTitle"]').value || '').trim(),
					winner: row.querySelector('[name="awardWinner"]').value.trim(),
				}));
				const agenda = [...byId('agenda-list').querySelectorAll('.row')].map((row) => ({
					planTime: row.querySelector('[name="planTimeDisplay"]').value.trim(),
					duration: row.querySelector('[name="agendaDuration"]').value.trim(),
					actualTime: row.querySelector('[name="actualTime"]').value.trim(),
					title: row.querySelector('[name="agendaTitle"]').value.trim(),
					speaker: row.querySelector('[name="agendaSpeaker"]').value.trim(),
				}));

				return {
					id: form.elements.id.value.trim(),
					type: form.elements.type.value.trim(),
					title: form.elements.title.value.trim(),
					wordOfToday: form.elements.wordOfToday.value.trim(),
					manager: form.elements.manager.value.trim(),
					date: form.elements.date.value.trim(),
					time: form.elements.time.value.trim(),
					location: form.elements.location.value.trim(),
					description: form.elements.description.value.trim(),
					image: form.elements.image.value.trim(),
					agendaStartTime: byId('agenda-start-time').value || '19:00',
					awards,
					agenda: agenda.filter((a) => a.title),
				};
			}

			function escapeHtml(value) {
				return String(value ?? '')
					.replaceAll('&', '&amp;')
					.replaceAll('<', '&lt;')
					.replaceAll('>', '&gt;')
					.replaceAll('"', '&quot;')
					.replaceAll("'", '&#39;');
			}

			async function toDataUrl(url) {
				const res = await fetch(url);
				if (!res.ok) throw new Error(`Failed to load image: ${res.status}`);
				const blob = await res.blob();
				return await new Promise((resolve, reject) => {
					const reader = new FileReader();
					reader.onload = () => resolve(String(reader.result || ''));
					reader.onerror = () => reject(new Error('Failed to read image'));
					reader.readAsDataURL(blob);
				});
			}

			async function printAgenda() {
				recomputeAgendaPlanTimes();
				const data = collectForm();
				const qrImageUrl = new URL(vpmCode, window.location.origin).href;
				const logo1Url = new URL(shipLogo, window.location.origin).href;
				const logo2Url = new URL(toastmastersLogo, window.location.origin).href;
				let qrPrintSrc = qrImageUrl;
				let logo1PrintSrc = logo1Url;
				let logo2PrintSrc = logo2Url;
				try {
					qrPrintSrc = await toDataUrl(qrImageUrl);
				} catch (err) {
					qrPrintSrc = qrImageUrl;
				}
				try {
					logo1PrintSrc = await toDataUrl(logo1Url);
				} catch (err) {
					logo1PrintSrc = logo1Url;
				}
				try {
					logo2PrintSrc = await toDataUrl(logo2Url);
				} catch (err) {
					logo2PrintSrc = logo2Url;
				}

				const agendaRows = (data.agenda || [])
					.map(
						(item, idx) => `
							<tr>
								<td>${escapeHtml(item.planTime)}</td>
								<td>${escapeHtml(item.title)}</td>
								<td>${escapeHtml(item.duration)}</td>
								<td>${escapeHtml(item.speaker)}</td>
							</tr>
						`
					)
					.join('');

				const html = `
					<!doctype html>
					<html lang="en">
						<head>
							<meta charset="utf-8" />
							<title>Agenda Print</title>
							<style>
								@page { size: A4 portrait; margin: 10mm; }
								* { box-sizing: border-box; }
								body { font-family: Arial, sans-serif; margin: 0; color: #111; }
								.sheet { width: 190mm; margin: 0 auto; }
								.header { border: 1px solid #333; border-bottom: 0; padding: 3mm 4mm 2.5mm; text-align: center; display: grid; grid-template-columns: 24mm 1fr 24mm; align-items: center; column-gap: 2mm; }
								.header-main { min-width: 0; }
								.logo-placeholder { width: 20mm; height: 20mm; border: 1px dashed #333; display: grid; place-items: center; font-size: 3mm; color: #666; margin: 0 auto; }
								.logo-image { width: 20mm; height: 20mm; object-fit: contain; display: block; margin: 0 auto; }
								.club { font-size: 7mm; font-weight: 700; letter-spacing: 0.2mm; line-height: 1.1; }
								.meta-line { margin-top: 1.2mm; font-size: 4.1mm; line-height: 1.3; }
								.theme-line { margin-top: 1.8mm; font-size: 4.8mm; font-weight: 600; }
								.layout { display: grid; grid-template-columns: 136mm 54mm; gap: 1.2mm; }
								table { width: 100%; border-collapse: collapse; table-layout: fixed; }
								.main-table { border: 1px solid #333; border-right: 0; }
								.main-table th, .main-table td { border: 0.5px solid #333; padding: 1.1mm 1.1mm; font-size: 3.2mm; text-align: center; vertical-align: middle; }
								.main-table th { background: #ececec; font-weight: 700; }
								.main-table col.time { width: 20mm; }
								.main-table col.session { width: auto; }
								.main-table col.duration { width: 15mm; }
								.main-table col.name { width: 22mm; }
								.side { border-top: 1px solid #333; border-right: 1px solid #333; border-bottom: 1px solid #333; border-left: 0; }
								.side-block { border-bottom: 1px solid #333; }
								.side-block:last-child { border-bottom: 0; }
								.side-title { font-size: 2.5mm; font-weight: 700; background: #ececec; padding: 1mm 1mm; border-bottom: 1px solid #333; }
								.side-content { padding: 1.7mm 2mm; font-size: 2.1mm; line-height: 1.25; }
								.manager-table td { border: 1px solid #333; padding: 1.2mm 1.2mm; font-size: 2.5mm; }
								.manager-table td:first-child { background: #ececec; width: 58%; font-weight: 700; }
								.qr-wrap { display: grid; place-items: center; gap: 1.2mm; padding: 1.6mm 0 0.8mm; }
								.qr-placeholder { width: 24mm; height: 24mm; border: 1px dashed #333; display: grid; place-items: center; font-size: 3mm; color: #666; }
								.qr-image { width: 24mm; height: 24mm; object-fit: contain; display: block; }
								.side-note { margin-top: 1.2mm; font-size: 2mm; line-height: 1; }
								.bottom-row { display: grid; grid-template-columns: 136mm 54mm; gap: 1.2mm; }
								.timer { margin-top: 2mm; border: 1px solid #333; width: 136mm; }
								.timer th, .timer td { border: 1px solid #333; font-size: 2.8mm; padding: 1mm 1mm; text-align: center; }
								.timer th { background: #ececec; }
								.vote-box { margin-top: 2mm; border: 1px solid #333; border-left: 0; display: grid; grid-template-columns: 13mm 1fr; min-height: 35mm; }
								.vote-label { border-right: 1px solid #333; background: #ececec; display: grid; place-items: center; font-size: 3.8mm; font-weight: 700; line-height: 1.3; text-align: center; }
								.vote-content { display: grid; place-items: center; padding: 2mm; }
								.vote-qr-placeholder { width: 26mm; height: 26mm; border: 1px dashed #333; display: grid; place-items: center; font-size: 3mm; color: #666; }
								.vote-qr-image { width: 26mm; height: 26mm; object-fit: contain; display: block; }
								.footer-note { border: 1px solid #333; border-top: 0; padding: 1.6mm 2mm; font-size: 3.2mm; text-align: center; width: 136mm; }
							</style>
						</head>
						<body>
							<div class="sheet">
								<div class="header">
									<img class="logo-image" src="${logo1PrintSrc}" alt="Ship Logo" />
									<div class="header-main">
										<div class="club">SHIP TOASTMASTER CLUB</div>
										<div class="meta-line">Time: ${escapeHtml(data.date)} ${escapeHtml(data.time)}</div>
										<div class="meta-line">Place: ${escapeHtml(data.location)}</div>
										<div class="theme-line">SHIP ${escapeHtml(data.id || '')} Meeting Theme: ${escapeHtml(data.title || 'Meeting Agenda')}</div>
									</div>
									<img class="logo-image" src="${logo2PrintSrc}" alt="Toastmasters Logo" />
								</div>
								<div class="layout">
									<table class="main-table">
										<colgroup>
											<col class="time" />
											<col class="session" />
											<col class="duration" />
											<col class="name" />
										</colgroup>
										<thead>
											<tr>
												<th>Time</th>
												<th>Session/Role</th>
												<th>Duration</th>
												<th>Name</th>
											</tr>
										</thead>
										<tbody>${agendaRows}</tbody>
									</table>
									<div class="side">
										<div class="side-block">
											<table class="manager-table" style="width:100%; border-collapse:collapse;">
												<tr><td>Meeting Manager</td><td>${escapeHtml(data.manager || '-')}</td></tr>
												<tr><td>Meeting Type</td><td>${escapeHtml(data.type || '-')}</td></tr>
												<tr><td>Word of Today</td><td>${escapeHtml(data.wordOfToday || '-')}</td></tr>
											</table>
										</div>
										<div class="side-block">
											<div class="side-title">Join us 如何加入SHIP？</div>
											<div class="side-content">
												<div class="qr-wrap">
													<img class="qr-image" src="${qrPrintSrc}" alt="VPM Code" />
												</div>
<div class="side-note">
<strong>Membership requirements:</strong><br>
3: Attend 3 meetings;<br>
2: speak on stage twice (role-based);<br>
1: submit 1 application.<br>
<strong>Membership fee:</strong><br>
350 Yuan: registration fee<br>
700 Yuan: semi-annual fee<br>
1300 Yuan: annual fee
</div>
											</div>
										</div>
										<div class="side-block">
											<div class="side-title">Guide for Guests 嘉宾参会指南</div>
											<div class="side-content">

											 <strong>Guest Introduction (30s)</strong><br>
  自我介绍，为什么参加 SHIP，兴趣爱好等<br>
  <strong>Table Topic Speech (2 mins)</strong><br>
  限 5–6 个参与名额，先抢先得<br>
  会员和观众都可以参与<br>
  想锻炼的勇敢冲！（P.S. 特殊例会无此环节，最终环节以 agenda 为准）<br>

  <strong>Moment of Truth (30–60s)</strong><br>
  分享你参会的感受，印象深刻的人或事，或表达感谢<br>

  <strong>More Opportunities</strong><br>
  可申请角色：Timer时间官，Grammarian语法官，Ah-counter哼哈官<br>

  期待遇见同频的你！<br>

  <strong>Let’s be Smart Happy Intellectual Passionate!</strong>



											</div>
										</div>
										<div class="side-block">
											<div class="side-title">Pathways 教育体系</div>
											<div class="side-content">
Pathways 是头马国际的教育体系的重要组成部分，共 6 条学习路径，针对性提高 5 项基本能力。<br><br>

<strong>6 条演讲路径 能力</strong><br> 
动态领袖 DL  Dynamic Leadership 1235 <br>
激励策略 MS  Motivational Strategies 1235<br>
幽默演讲 EH  Engaging Humor 1245<br>
说服影响 PI  Persuasive Influence 1325<br>
精通演讲 PM  Presentation Mastery 15<br>
愿景沟通 VC  Visionary Communication 1325<br><br>

<strong>能力速查 →</strong><br>
1：公众表达 PS   2：人际沟通 IC<br>
3：战略领袖 SL   4：管理 M<br>
5：自信 C<br>

你无法通过听课而提升自信，但你走完每条路径时会变得更自信。 We learn by doing.


											</div>
										</div>
										<div class="side-block">
											<div class="side-title">4 Habits </div>
											<div class="side-content">1. 手机静音 Mute mobile phone.<br>
2. 上台握手 Shake hands with TME.<br>
3. 勿随意走动 No walking in/out.<br>
4. 保持安静 Keep quiet when someone is speaking.
</div>
										</div>

											<div class="side-block">
											<div class="side-title">4 Taboos</div>
											<div class="side-content">Politics，Religion，Sex，Bad taste</div>
										</div>


									</div>
								</div>
								<div class="bottom-row">
									<div>
										<table class="timer">
											<thead>
												<tr>
													<th></th>
													<th>Short Speeches &le; 3 min</th>
													<th>Long Speeches &lt; 10 min</th>
													<th>Long Speeches &ge; 10 min</th>
												</tr>
											</thead>
											<tbody>
												<tr><th>Green</th><td>1 minute left</td><td>2 minutes left</td><td>5 minutes left</td></tr>
												<tr><th>Yellow</th><td>30 seconds left</td><td>1 minute left</td><td>2 minutes left</td></tr>
												<tr><th>Red</th><td colspan="3">Time is up</td></tr>
												<tr>
												<th>Ring</th>
												<td>after 15",Timer will ring to stop the speaker</td>
												<td colspan="2">after 30",Timer will ring to stop the speaker</td>
											
												</tr>
											</tbody>
										</table>
										
									</div>
									<div class="vote-box">
										<div class="vote-label">Vote<br />link</div>
										<div class="vote-content">
											<img class="vote-qr-image" src="${qrPrintSrc}" alt="Vote QR Code" />
										</div>
									</div>
								</div>
							</div>
						</body>
					</html>
				`;

				const frame = document.createElement('iframe');
				frame.style.position = 'fixed';
				frame.style.right = '0';
				frame.style.bottom = '0';
				frame.style.width = '0';
				frame.style.height = '0';
				frame.style.border = '0';
				frame.setAttribute('aria-hidden', 'true');
				document.body.appendChild(frame);

				const doc = frame.contentDocument || frame.contentWindow?.document;
				if (!doc || !frame.contentWindow) {
					frame.remove();
					alert('Print failed. Please try again.');
					return;
				}

				doc.open();
				doc.write(html);
				doc.close();
				const images = [...doc.images];
				await Promise.all(
					images.map(
						(img) =>
							new Promise((resolve) => {
								if (img.complete) resolve(true);
								else {
									img.onload = () => resolve(true);
									img.onerror = () => resolve(true);
								}
							})
					)
				);
				frame.contentWindow.focus();
				frame.contentWindow.print();
				setTimeout(() => frame.remove(), 1200);
			}

			function loadStandardTemplate() {
				byId('agenda-start-time').value = '19:00';
				byId('agenda-list').innerHTML = '';
				STANDARD_TEMPLATE.forEach((item) => byId('agenda-list').appendChild(makeAgendaRow(item)));
				recomputeAgendaPlanTimes();
			}

			byId('login-form').addEventListener('submit', (evt) => {
				evt.preventDefault();
				const account = byId('account').value.trim();
				const password = byId('password').value.trim();
				if (account === ACCOUNT && password === PASSWORD) {
					setAuth(true);
					setView();
					loadMeetings();
					renderMeetingList();
					if (meetings.length) loadToForm(0);
				} else {
					alert('Invalid account or password');
				}
			});

			byId('logout').addEventListener('click', () => {
				setAuth(false);
				setView();
			});

			byId('new-meeting').addEventListener('click', newMeeting);
			byId('add-agenda').addEventListener('click', () => {
				byId('agenda-list').appendChild(makeAgendaRow());
				recomputeAgendaPlanTimes();
			});
			byId('print-agenda').addEventListener('click', printAgenda);
			byId('load-template').addEventListener('click', loadStandardTemplate);
			byId('agenda-start-time').addEventListener('input', recomputeAgendaPlanTimes);

			byId('meeting-form').addEventListener('submit', (evt) => {
				evt.preventDefault();
				const next = collectForm();
				if (editingIndex === null) {
					meetings.unshift(next);
					editingIndex = 0;
				} else {
					meetings[editingIndex] = next;
				}
				saveMeetings();
				renderMeetingList();
				alert('Meeting saved');
			});

			byId('delete-meeting').addEventListener('click', () => {
				if (editingIndex === null) return;
				meetings.splice(editingIndex, 1);
				saveMeetings();
				if (meetings.length) loadToForm(0);
				else newMeeting();
			});

			bindFileUpload();
			loadMeetings();
			setView();
			if (isAuth()) {
				renderMeetingList();
				if (meetings.length) loadToForm(0);
				else newMeeting();
			}
		</script>
	</body>
</html>

<style is:global>
	.console-page {
		--c-bg: rgba(255, 255, 255, 0.9);
		--c-line: rgba(10, 132, 255, 0.2);
		--c-line-strong: rgba(10, 132, 255, 0.4);
		--c-text: #1b2b43;
		--c-muted: #5c6f8f;
		--c-blue: #0a84ff;
		--c-blue-dark: #0668da;
		width: min(1220px, calc(100% - 2rem));
		margin: 0 auto;
		padding: 1.8rem 0 4rem;
		font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
		font-size: 16px;
		color: var(--c-text);
	}
	.console-page .panel {
		background: var(--c-bg);
		border: 1px solid var(--c-line);
		border-radius: 1.1rem;
		box-shadow: 0 16px 36px rgba(13, 45, 99, 0.08);
		padding: 1.15rem;
		backdrop-filter: blur(8px);
	}
	.console-page .hidden {
		display: none;
	}
	.console-page h1 {
		font-size: clamp(1.4rem, 2vw, 1.9rem);
		margin: 0 0 0.3rem;
		letter-spacing: -0.01em;
	}
	.console-page h2 {
		font-size: 1.05rem;
		margin: 0 0 0.65rem;
	}
	.console-page #login-panel p {
		margin: 0 0 0.8rem;
		color: var(--c-muted);
	}
	.console-page #login-form {
		display: grid;
		gap: 0.75rem;
		max-width: 360px;
	}
	.console-page label {
		display: grid;
		gap: 0.28rem;
		font-size: 0.9rem;
	}
	.console-page input,
	.console-page textarea,
	.console-page select,
	.console-page button {
		font: inherit;
	}
	.console-page input,
	.console-page textarea,
	.console-page select {
		border: 1px solid rgba(11, 73, 146, 0.2);
		border-radius: 0.65rem;
		padding: 0.52rem 0.68rem;
		background: #fff;
		color: var(--c-text);
		transition: border-color 0.18s ease, box-shadow 0.18s ease;
	}
	.console-page input:focus,
	.console-page textarea:focus,
	.console-page select:focus {
		outline: 0;
		border-color: var(--c-line-strong);
		box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.14);
	}
	.console-page button {
		border: 0;
		border-radius: 0.62rem;
		padding: 0.5rem 0.74rem;
		background: var(--c-blue);
		color: white;
		cursor: pointer;
		transition: transform 0.12s ease, background-color 0.18s ease;
	}
	.console-page button:hover {
		background: var(--c-blue-dark);
	}
	.console-page button:active {
		transform: translateY(1px);
	}
	.console-page .app-head {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 0.8rem;
	}
	.console-page .app-actions {
		display: flex;
		gap: 0.45rem;
	}
	.console-page .layout {
		margin-top: 1rem;
		display: grid;
		grid-template-columns: 290px minmax(0, 1fr);
		gap: 1rem;
		align-items: start;
	}
	.console-page .list {
		display: grid;
		gap: 0.5rem;
		max-height: 68vh;
		overflow: auto;
		padding-right: 0.15rem;
	}
	.console-page .meeting-item {
		text-align: left;
		background: #f7faff;
		color: #23395f;
		border: 1px solid rgba(9, 92, 183, 0.2);
		padding: 0.56rem 0.64rem;
	}
	.console-page .meeting-item strong,
	.console-page .meeting-item span,
	.console-page .meeting-item small {
		display: block;
	}
	.console-page .meeting-item.active {
		background: #eaf4ff;
		border-color: #0a84ff;
	}
	.console-page .meeting-item small {
		color: var(--c-muted);
	}
	.console-page .editor-form {
		display: grid;
		gap: 0.62rem;
	}
	.console-page .editor-field {
		display: grid;
		grid-template-columns: 120px minmax(0, 1fr);
		align-items: center;
		gap: 0.6rem;
		font-size: 0.9rem;
	}
	.console-page .editor-label {
		color: var(--c-muted);
		font-weight: 600;
	}
	.console-page .editor-field textarea {
		min-height: 120px;
	}
	.console-page .editor-field.file-label input {
		margin-top: 0;
	}
	.console-page .file-label input {
		margin-top: 0.32rem;
	}
	.console-page .sub-block {
		border: 1px solid var(--c-line);
		border-radius: 0.8rem;
		padding: 0.6rem;
		background: #fbfdff;
		overflow-x: auto;
	}
	.console-page .sub-head {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 0.55rem;
		gap: 0.5rem;
	}
	.console-page .sub-head h3 {
		margin: 0;
		font-size: 1rem;
	}
	.console-page .agenda-tools {
		display: inline-flex;
		align-items: center;
		gap: 0.4rem;
		flex-wrap: wrap;
	}
	.console-page .start-time-label {
		display: inline-flex;
		align-items: center;
		gap: 0.3rem;
		font-size: 0.78rem;
		color: var(--c-muted);
	}
	.console-page .start-time-label input {
		padding: 0.35rem 0.45rem;
	}
	.console-page .agenda-head {
		display: grid;
		grid-template-columns: 64px 78px minmax(120px, 1fr) 140px 100px 40px 34px;
		gap: 0.45rem;
		margin-bottom: 0.5rem;
		font-size: 0.74rem;
		font-weight: 700;
		color: #56719c;
		min-width: 560px;
	}
	.console-page .agenda-head span:last-child {
		text-align: center;
	}
	.console-page .row {
		display: grid;
		grid-template-columns: repeat(2, minmax(0, 1fr)) auto;
		gap: 0.45rem;
		margin-bottom: 0.45rem;
	}
	.console-page .award-row {
		grid-template-columns: repeat(2, minmax(0, 1fr));
	}
	.console-page .award-row [name='awardTitle'] {
		background: #f3f7ff;
		color: #496a96;
		font-weight: 600;
	}
	.console-page .agenda-row {
		grid-template-columns: 64px 78px minmax(120px, 1fr) 140px 100px 40px 34px;
		align-items: center;
		min-width: 560px;
	}
	.console-page .agenda-row [name='planTimeDisplay'] {
		background: #f3f7ff;
		color: #496a96;
		font-weight: 600;
	}
	.console-page .agenda-head span:nth-child(5) {
		color: #b37a00;
	}
	.console-page .agenda-row [name='actualTime'] {
		background: #fff4cc;
		border-color: rgba(179, 122, 0, 0.35);
		color: #7a5400;
	}
	.console-page .status-pill {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 14px;
		height: 14px;
		border-radius: 999px;
		justify-self: center;
		border: 1px solid rgba(90, 110, 140, 0.25);
	}
	.console-page .status-neutral {
		background: #dbe4f1;
	}
	.console-page .status-green {
		background: #2ec37d;
		border-color: rgba(24, 122, 75, 0.35);
	}
	.console-page .status-red {
		background: #ff5b67;
		border-color: rgba(166, 36, 52, 0.35);
	}
	.console-page .remove {
		background: #ff5e66;
	}
	.console-page .form-actions {
		display: flex;
		gap: 0.5rem;
	}
	.console-page #delete-meeting {
		background: #d13e4f;
	}
	.console-page #delete-meeting:hover {
		background: #bc3142;
	}
	@media (max-width: 980px) {
		.console-page .layout {
			grid-template-columns: 1fr;
		}
	}
</style>
