---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import { defaultMeetings } from '../data/meetings';
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`${SITE_TITLE} | Console`} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main class="console-page">
			<section class="console-wrap">
				<div id="login-panel" class="panel">
					<h1>SHIP Console</h1>
					<p>Login to manage meetings.</p>
					<form id="login-form">
						<label>Account <input id="account" type="text" autocomplete="username" required /></label>
						<label>Password <input id="password" type="password" autocomplete="current-password" required /></label>
						<button type="submit">Login</button>
					</form>
				</div>

				<div id="app-panel" class="panel hidden">
					<div class="app-head">
						<h1>Meeting Admin</h1>
						<div class="app-actions">
							<button id="new-meeting" type="button">New Meeting</button>
							<button id="logout" type="button">Logout</button>
						</div>
					</div>

					<div class="layout">
						<section>
							<h2>Meetings</h2>
							<div id="meeting-list" class="list"></div>
						</section>

						<section>
							<h2>Editor</h2>
							<form id="meeting-form" class="editor-form">
								<input name="id" placeholder="#442" required />
								<input name="type" placeholder="Regular" required />
								<input name="title" placeholder="Title" required />
								<input name="manager" placeholder="Manager" required />
								<input name="date" placeholder="YYYY-MM-DD" required />
								<input name="time" placeholder="19:15:00 - 21:30:00" required />
								<input name="location" placeholder="Location" required />
								<input name="image" placeholder="Image URL or Base64" />
								<textarea name="description" placeholder="Description" rows="4" required></textarea>
								<label class="file-label">
									Upload Image
									<input id="image-file" type="file" accept="image/*" />
								</label>

								<div class="sub-block">
									<div class="sub-head">
										<h3>Awards</h3>
										<button id="add-award" type="button">+ Award</button>
									</div>
									<div id="award-list"></div>
								</div>

								<div class="sub-block">
									<div class="sub-head">
										<h3>Agenda</h3>
										<div class="agenda-tools">
											<label class="start-time-label">
												Start
												<input id="agenda-start-time" type="time" value="19:00" />
											</label>
											<button id="load-template" type="button">Load Standard Template</button>
											<button id="add-agenda" type="button">+ Agenda Item</button>
										</div>
									</div>
									<div class="agenda-head">
										<span>Plan time</span>
										<span>Duration (min)</span>
										<span>Agenda title</span>
										<span>Role taker</span>
										<span>Actual duration</span>
										<span>Signal</span>
										<span></span>
									</div>
									<div id="agenda-list"></div>
								</div>

								<div class="form-actions">
									<button type="submit">Save</button>
									<button id="delete-meeting" type="button">Delete</button>
								</div>
							</form>
						</section>
					</div>
				</div>
			</section>
		</main>
		<Footer />

		<script is:inline define:vars={{ defaultMeetings }}>
			const DEFAULT_MEETINGS = Array.isArray(defaultMeetings) ? defaultMeetings : [];
			const STORAGE_KEY = 'ship_meetings_v1';
			const AUTH_KEY = 'ship_console_auth';
			const ACCOUNT = 'ship';
			const PASSWORD = 'ship';
			const STANDARD_TEMPLATE = [
				{ duration: '1', title: 'Welcome and meeting rules', speaker: 'Horatio' },
				{ duration: '2', title: 'Opening', speaker: 'Gianna' },
				{ duration: '1', title: 'Toastmaster of the Evening', speaker: 'Nico' },
				{ duration: '1', title: 'Timer Introduction', speaker: 'Bubbles' },
				{ duration: '1', title: 'Grammarian Introduction', speaker: 'Leta' },
				{ duration: '1', title: 'Hark master Introduction', speaker: 'Dustin' },
				{ duration: '7', title: 'IP 3-1 the translator', speaker: 'Nico' },
				{ duration: '7', title: 'PM 4-1 My "Unofficial" Story', speaker: 'Sophie' },
				{ duration: '3', title: 'Speech by Mark', speaker: 'Mark' },
				{ duration: '5', title: 'Guest Introduction', speaker: 'Rraion' },
				{ duration: '3', title: 'Camera Flow Program', speaker: 'Angela' },
				{ duration: '10', title: 'Break', speaker: 'All' },
				{ duration: '25', title: 'Table Topic: Sense of Ritual or Formalism', speaker: 'Gianna' },
				{ duration: '3', title: "Evaluation to Nico", speaker: 'Bella' },
				{ duration: '3', title: "Evaluation to Sophie", speaker: 'Portia' },
				{ duration: '3', title: 'Evaluation to Mark', speaker: 'Charmni' },
				{ duration: '7', title: 'Table Topic Evaluation', speaker: 'Jurgen' },
				{ duration: '2', title: 'Grammarian Report', speaker: 'Leta' },
				{ duration: '3', title: 'Hark master Report', speaker: 'Dustin' },
				{ duration: '2', title: 'Timer Report', speaker: 'Bubbles' },
				{ duration: '1', title: 'Vote for the best', speaker: 'All' },
				{ duration: '8', title: 'Moment of truth', speaker: 'Horatio' },
				{ duration: '2', title: 'Award ceremony', speaker: 'Angela' },
				{ duration: '1', title: 'Closing', speaker: 'Gianna' },
			];

			const qs = (s) => document.querySelector(s);
			const byId = (s) => document.getElementById(s);

			let meetings = [];
			let editingIndex = null;

				function loadMeetings() {
					try {
						const raw = localStorage.getItem(STORAGE_KEY);
						meetings = raw ? JSON.parse(raw) : DEFAULT_MEETINGS;
						if (!Array.isArray(meetings)) meetings = DEFAULT_MEETINGS;
					} catch (err) {
						meetings = DEFAULT_MEETINGS;
					}
				}

			function saveMeetings() {
				localStorage.setItem(STORAGE_KEY, JSON.stringify(meetings));
				renderMeetingList();
			}

			function isAuth() {
				return sessionStorage.getItem(AUTH_KEY) === '1';
			}

			function setAuth(ok) {
				if (ok) sessionStorage.setItem(AUTH_KEY, '1');
				else sessionStorage.removeItem(AUTH_KEY);
			}

			function setView() {
				byId('login-panel').classList.toggle('hidden', isAuth());
				byId('app-panel').classList.toggle('hidden', !isAuth());
			}

			function makeAwardRow(data = { title: '', winner: '' }) {
				const row = document.createElement('div');
				row.className = 'row';
				row.innerHTML = `
					<input name="awardTitle" placeholder="Award title" value="${data.title || ''}" />
					<input name="awardWinner" placeholder="Winner" value="${data.winner || ''}" />
					<button type="button" class="remove">x</button>
				`;
				row.querySelector('.remove').addEventListener('click', () => row.remove());
				return row;
			}

			function parseMinutes(text) {
				const m = String(text || '').match(/(\d+)/);
				return m ? Number(m[1]) : NaN;
			}

			function timeToMinutes(hhmm) {
				const m = String(hhmm || '').trim().match(/^(\d{1,2}):(\d{2})$/);
				if (!m) return NaN;
				return Number(m[1]) * 60 + Number(m[2]);
			}

			function minutesToTime(total) {
				if (!Number.isFinite(total)) return '';
				const fixed = ((total % 1440) + 1440) % 1440;
				const h = String(Math.floor(fixed / 60)).padStart(2, '0');
				const m = String(fixed % 60).padStart(2, '0');
				return `${h}:${m}`;
			}

			function parseActualRange(value) {
					const raw = String(value || '').replaceAll('—', '-').replaceAll('–', '-').trim();
					const pureMinutes = raw.match(/^\d+$/);
					if (pureMinutes) {
						const mins = Number(pureMinutes[0]);
						return Number.isFinite(mins) ? { start: 0, end: mins } : null;
					}
					const parts = raw.split('-').map((p) => p.trim()).filter(Boolean);
					if (parts.length >= 2) {
						const start = timeToMinutes(parts[0]);
						const end = timeToMinutes(parts[1]);
						if (Number.isFinite(start) && Number.isFinite(end)) {
							return { start, end: end < start ? end + 24 * 60 : end };
						}
					}
					if (parts.length === 1) {
						const only = timeToMinutes(parts[0]);
						if (Number.isFinite(only)) return { start: only, end: only };
					}
					return null;
				}

			function getStatusClass(actualTime, duration) {
				const range = parseActualRange(actualTime);
				const dur = parseMinutes(duration);
				if (!range || !Number.isFinite(dur) || dur <= 0) return 'status-neutral';
				const actualDur = range.end - range.start;
				return actualDur <= dur ? 'status-green' : 'status-red';
			}

			function recomputeAgendaPlanTimes() {
				const rows = [...byId('agenda-list').querySelectorAll('.agenda-row')];
				let nextPlan = timeToMinutes(byId('agenda-start-time').value);
				if (!Number.isFinite(nextPlan)) nextPlan = timeToMinutes('19:00');
				nextPlan += 30;

				rows.forEach((row, idx) => {
					const planInput = row.querySelector('[name="planTimeDisplay"]');
					const durationInput = row.querySelector('[name="agendaDuration"]');
					const actualInput = row.querySelector('[name="actualTime"]');
					const status = row.querySelector('.status-pill');

					if (idx === 0) {
						planInput.value = minutesToTime(nextPlan);
					} else {
						const prevRow = rows[idx - 1];
						const prevDuration = prevRow.querySelector('[name="agendaDuration"]').value;
						const prevPlan = prevRow.querySelector('[name="planTimeDisplay"]').value;
						const prevDur = parseMinutes(prevDuration);
						const prevPlanMin = timeToMinutes(prevPlan);
						if (Number.isFinite(prevPlanMin)) {
							nextPlan = prevPlanMin + (Number.isFinite(prevDur) ? prevDur : 0) + 1;
						}
						planInput.value = minutesToTime(nextPlan);
					}

					const statusClass = getStatusClass(actualInput.value, durationInput.value);
					status.className = `status-pill ${statusClass}`;
					status.textContent = '';
					status.title =
						statusClass === 'status-green'
							? 'On time'
							: statusClass === 'status-red'
								? 'Over time'
								: 'Waiting actual time';
				});
			}

			function makeAgendaRow(data = { duration: '', actualTime: '', title: '', speaker: '' }) {
				const row = document.createElement('div');
				row.className = 'row agenda-row';
				row.innerHTML = `
					<input name="planTimeDisplay" placeholder="Auto" readonly />
					<input name="agendaDuration" placeholder="2" value="${data.duration || data.planDuration || ''}" />
					<input name="agendaTitle" placeholder="Agenda title" value="${data.title || ''}" />
					<input name="agendaSpeaker" placeholder="Speaker" value="${data.speaker || ''}" />
					<input name="actualTime" placeholder="Actual duration" value="${data.actualTime || ''}" />
					<span class="status-pill status-neutral" title="Status preview"></span>
					<button type="button" class="remove">x</button>
				`;
				row.querySelector('.remove').addEventListener('click', () => {
					row.remove();
					recomputeAgendaPlanTimes();
				});
				row.querySelector('[name="agendaDuration"]').addEventListener('input', recomputeAgendaPlanTimes);
				row.querySelector('[name="actualTime"]').addEventListener('input', recomputeAgendaPlanTimes);
				return row;
			}

				function bindFileUpload() {
					byId('image-file').addEventListener('change', (evt) => {
						const target = evt.target;
						const files = target && target.files ? target.files : null;
						const file = files && files.length ? files[0] : null;
						if (!file) return;
						const reader = new FileReader();
					reader.onload = () => {
						const input = qs('[name="image"]');
						input.value = String(reader.result || '');
					};
					reader.readAsDataURL(file);
				});
			}

			function renderMeetingList() {
				const list = byId('meeting-list');
				list.innerHTML = meetings
					.map(
						(item, idx) => `
							<button type="button" class="meeting-item ${idx === editingIndex ? 'active' : ''}" data-idx="${idx}">
								<strong>${item.id}</strong>
								<span>${item.title}</span>
								<small>${item.date}</small>
							</button>
						`
					)
					.join('');
				list.querySelectorAll('[data-idx]').forEach((btn) => {
					btn.addEventListener('click', () => loadToForm(Number(btn.dataset.idx)));
				});
			}

			function clearRows() {
				byId('award-list').innerHTML = '';
				byId('agenda-list').innerHTML = '';
			}

			function loadToForm(idx) {
				const form = byId('meeting-form');
				const item = meetings[idx];
				if (!item) return;
				editingIndex = idx;
				['id', 'type', 'title', 'manager', 'date', 'time', 'location', 'description', 'image'].forEach((k) => {
					form.elements[k].value = item[k] || '';
				});
				byId('agenda-start-time').value = item.agendaStartTime || '19:00';
				clearRows();
				(item.awards || []).forEach((a) => byId('award-list').appendChild(makeAwardRow(a)));
				(item.agenda || []).forEach((a) => byId('agenda-list').appendChild(makeAgendaRow(a)));
				recomputeAgendaPlanTimes();
				renderMeetingList();
			}

			function newMeeting() {
				editingIndex = null;
				const form = byId('meeting-form');
				form.reset();
				byId('agenda-start-time').value = '19:00';
				clearRows();
				byId('award-list').appendChild(makeAwardRow());
				byId('agenda-list').appendChild(makeAgendaRow());
				recomputeAgendaPlanTimes();
				renderMeetingList();
			}

			function collectForm() {
				const form = byId('meeting-form');
				const awards = [...byId('award-list').querySelectorAll('.row')].map((row) => ({
					title: row.querySelector('[name="awardTitle"]').value.trim(),
					winner: row.querySelector('[name="awardWinner"]').value.trim(),
				}));
				const agenda = [...byId('agenda-list').querySelectorAll('.row')].map((row) => ({
					planTime: row.querySelector('[name="planTimeDisplay"]').value.trim(),
					duration: row.querySelector('[name="agendaDuration"]').value.trim(),
					actualTime: row.querySelector('[name="actualTime"]').value.trim(),
					title: row.querySelector('[name="agendaTitle"]').value.trim(),
					speaker: row.querySelector('[name="agendaSpeaker"]').value.trim(),
				}));

				return {
					id: form.elements.id.value.trim(),
					type: form.elements.type.value.trim(),
					title: form.elements.title.value.trim(),
					manager: form.elements.manager.value.trim(),
					date: form.elements.date.value.trim(),
					time: form.elements.time.value.trim(),
					location: form.elements.location.value.trim(),
					description: form.elements.description.value.trim(),
					image: form.elements.image.value.trim(),
					agendaStartTime: byId('agenda-start-time').value || '19:00',
					awards: awards.filter((a) => a.title || a.winner),
					agenda: agenda.filter((a) => a.title),
				};
			}

			function loadStandardTemplate() {
				byId('agenda-start-time').value = '19:00';
				byId('agenda-list').innerHTML = '';
				STANDARD_TEMPLATE.forEach((item) => byId('agenda-list').appendChild(makeAgendaRow(item)));
				recomputeAgendaPlanTimes();
			}

			byId('login-form').addEventListener('submit', (evt) => {
				evt.preventDefault();
				const account = byId('account').value.trim();
				const password = byId('password').value.trim();
				if (account === ACCOUNT && password === PASSWORD) {
					setAuth(true);
					setView();
					loadMeetings();
					renderMeetingList();
					if (meetings.length) loadToForm(0);
				} else {
					alert('Invalid account or password');
				}
			});

			byId('logout').addEventListener('click', () => {
				setAuth(false);
				setView();
			});

			byId('new-meeting').addEventListener('click', newMeeting);
			byId('add-award').addEventListener('click', () => byId('award-list').appendChild(makeAwardRow()));
			byId('add-agenda').addEventListener('click', () => {
				byId('agenda-list').appendChild(makeAgendaRow());
				recomputeAgendaPlanTimes();
			});
			byId('load-template').addEventListener('click', loadStandardTemplate);
			byId('agenda-start-time').addEventListener('input', recomputeAgendaPlanTimes);

			byId('meeting-form').addEventListener('submit', (evt) => {
				evt.preventDefault();
				const next = collectForm();
				if (editingIndex === null) {
					meetings.unshift(next);
					editingIndex = 0;
				} else {
					meetings[editingIndex] = next;
				}
				saveMeetings();
				renderMeetingList();
				alert('Meeting saved');
			});

			byId('delete-meeting').addEventListener('click', () => {
				if (editingIndex === null) return;
				meetings.splice(editingIndex, 1);
				saveMeetings();
				if (meetings.length) loadToForm(0);
				else newMeeting();
			});

			bindFileUpload();
			loadMeetings();
			setView();
			if (isAuth()) {
				renderMeetingList();
				if (meetings.length) loadToForm(0);
				else newMeeting();
			}
		</script>
	</body>
</html>

<style is:global>
	.console-page {
		--c-bg: rgba(255, 255, 255, 0.9);
		--c-line: rgba(10, 132, 255, 0.2);
		--c-line-strong: rgba(10, 132, 255, 0.4);
		--c-text: #1b2b43;
		--c-muted: #5c6f8f;
		--c-blue: #0a84ff;
		--c-blue-dark: #0668da;
		width: min(1220px, calc(100% - 2rem));
		margin: 0 auto;
		padding: 1.8rem 0 4rem;
		font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
		font-size: 16px;
		color: var(--c-text);
	}
	.console-page .panel {
		background: var(--c-bg);
		border: 1px solid var(--c-line);
		border-radius: 1.1rem;
		box-shadow: 0 16px 36px rgba(13, 45, 99, 0.08);
		padding: 1.15rem;
		backdrop-filter: blur(8px);
	}
	.console-page .hidden {
		display: none;
	}
	.console-page h1 {
		font-size: clamp(1.4rem, 2vw, 1.9rem);
		margin: 0 0 0.3rem;
		letter-spacing: -0.01em;
	}
	.console-page h2 {
		font-size: 1.05rem;
		margin: 0 0 0.65rem;
	}
	.console-page #login-panel p {
		margin: 0 0 0.8rem;
		color: var(--c-muted);
	}
	.console-page #login-form {
		display: grid;
		gap: 0.75rem;
		max-width: 360px;
	}
	.console-page label {
		display: grid;
		gap: 0.28rem;
		font-size: 0.9rem;
	}
	.console-page input,
	.console-page textarea,
	.console-page select,
	.console-page button {
		font: inherit;
	}
	.console-page input,
	.console-page textarea,
	.console-page select {
		border: 1px solid rgba(11, 73, 146, 0.2);
		border-radius: 0.65rem;
		padding: 0.52rem 0.68rem;
		background: #fff;
		color: var(--c-text);
		transition: border-color 0.18s ease, box-shadow 0.18s ease;
	}
	.console-page input:focus,
	.console-page textarea:focus,
	.console-page select:focus {
		outline: 0;
		border-color: var(--c-line-strong);
		box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.14);
	}
	.console-page button {
		border: 0;
		border-radius: 0.62rem;
		padding: 0.5rem 0.74rem;
		background: var(--c-blue);
		color: white;
		cursor: pointer;
		transition: transform 0.12s ease, background-color 0.18s ease;
	}
	.console-page button:hover {
		background: var(--c-blue-dark);
	}
	.console-page button:active {
		transform: translateY(1px);
	}
	.console-page .app-head {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 0.8rem;
	}
	.console-page .app-actions {
		display: flex;
		gap: 0.45rem;
	}
	.console-page .layout {
		margin-top: 1rem;
		display: grid;
		grid-template-columns: 290px minmax(0, 1fr);
		gap: 1rem;
		align-items: start;
	}
	.console-page .list {
		display: grid;
		gap: 0.5rem;
		max-height: 68vh;
		overflow: auto;
		padding-right: 0.15rem;
	}
	.console-page .meeting-item {
		text-align: left;
		background: #f7faff;
		color: #23395f;
		border: 1px solid rgba(9, 92, 183, 0.2);
		padding: 0.56rem 0.64rem;
	}
	.console-page .meeting-item strong,
	.console-page .meeting-item span,
	.console-page .meeting-item small {
		display: block;
	}
	.console-page .meeting-item.active {
		background: #eaf4ff;
		border-color: #0a84ff;
	}
	.console-page .meeting-item small {
		color: var(--c-muted);
	}
	.console-page .editor-form {
		display: grid;
		gap: 0.62rem;
	}
	.console-page .file-label input {
		margin-top: 0.32rem;
	}
	.console-page .sub-block {
		border: 1px solid var(--c-line);
		border-radius: 0.8rem;
		padding: 0.6rem;
		background: #fbfdff;
		overflow-x: auto;
	}
	.console-page .sub-head {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 0.55rem;
		gap: 0.5rem;
	}
	.console-page .sub-head h3 {
		margin: 0;
		font-size: 1rem;
	}
	.console-page .agenda-tools {
		display: inline-flex;
		align-items: center;
		gap: 0.4rem;
		flex-wrap: wrap;
	}
	.console-page .start-time-label {
		display: inline-flex;
		align-items: center;
		gap: 0.3rem;
		font-size: 0.78rem;
		color: var(--c-muted);
	}
	.console-page .start-time-label input {
		padding: 0.35rem 0.45rem;
	}
	.console-page .agenda-head {
		display: grid;
		grid-template-columns: 64px 78px minmax(120px, 1fr) 140px 100px 40px 34px;
		gap: 0.45rem;
		margin-bottom: 0.5rem;
		font-size: 0.74rem;
		font-weight: 700;
		color: #56719c;
		min-width: 560px;
	}
	.console-page .agenda-head span:last-child {
		text-align: center;
	}
	.console-page .row {
		display: grid;
		grid-template-columns: repeat(2, minmax(0, 1fr)) auto;
		gap: 0.45rem;
		margin-bottom: 0.45rem;
	}
	.console-page .agenda-row {
		grid-template-columns: 64px 78px minmax(120px, 1fr) 140px 100px 40px 34px;
		align-items: center;
		min-width: 560px;
	}
	.console-page .agenda-row [name='planTimeDisplay'] {
		background: #f3f7ff;
		color: #496a96;
		font-weight: 600;
	}
	.console-page .agenda-head span:nth-child(5) {
		color: #b37a00;
	}
	.console-page .agenda-row [name='actualTime'] {
		background: #fff4cc;
		border-color: rgba(179, 122, 0, 0.35);
		color: #7a5400;
	}
	.console-page .status-pill {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 14px;
		height: 14px;
		border-radius: 999px;
		justify-self: center;
		border: 1px solid rgba(90, 110, 140, 0.25);
	}
	.console-page .status-neutral {
		background: #dbe4f1;
	}
	.console-page .status-green {
		background: #2ec37d;
		border-color: rgba(24, 122, 75, 0.35);
	}
	.console-page .status-red {
		background: #ff5b67;
		border-color: rgba(166, 36, 52, 0.35);
	}
	.console-page .remove {
		background: #ff5e66;
	}
	.console-page .form-actions {
		display: flex;
		gap: 0.5rem;
	}
	.console-page #delete-meeting {
		background: #d13e4f;
	}
	.console-page #delete-meeting:hover {
		background: #bc3142;
	}
	@media (max-width: 980px) {
		.console-page .layout {
			grid-template-columns: 1fr;
		}
	}
</style>

