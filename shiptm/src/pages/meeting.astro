---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import { defaultMeetings } from '../data/meetings';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL ?? '';
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY ?? '';
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`${SITE_TITLE} | Meetings`} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main class="meeting-page">
			<section class="hero">
				<h1>Meetings</h1>
				<p>Live data from SHIP Console</p>
			</section>

			<section id="meeting-list" class="meeting-list"></section>
		</main>
		<Footer />

		<script is:inline define:vars={{ defaultMeetings, supabaseUrl, supabaseAnonKey }}>
			const DEFAULT_MEETINGS = Array.isArray(defaultMeetings) ? defaultMeetings : [];
			const STORAGE_KEY = 'ship_meetings_v1';
			const REMOTE_TABLE = 'ship_meeting_store';
			const REMOTE_ROW_ID = 'main';
			const REMOTE_URL = String(supabaseUrl || '').trim().replace(/\/+$/, '');
			const REMOTE_ANON_KEY = String(supabaseAnonKey || '').trim();
			const REMOTE_ENABLED = Boolean(REMOTE_URL && REMOTE_ANON_KEY);

			const escapeHtml = (value) =>
				String(value ?? '')
					.replaceAll('&', '&amp;')
					.replaceAll('<', '&lt;')
					.replaceAll('>', '&gt;')
					.replaceAll('"', '&quot;')
					.replaceAll("'", '&#39;');

			function getMeetingsFromLocal() {
				try {
					const raw = localStorage.getItem(STORAGE_KEY);
					if (!raw) return DEFAULT_MEETINGS;
					const parsed = JSON.parse(raw);
					return Array.isArray(parsed) ? parsed : DEFAULT_MEETINGS;
				} catch {
					return DEFAULT_MEETINGS;
				}
			}

			async function getMeetingsFromRemote() {
				if (!REMOTE_ENABLED) return null;
				try {
					const cacheBuster = `_ts=${Date.now()}`;
					const url = `${REMOTE_URL}/rest/v1/${REMOTE_TABLE}?id=eq.${encodeURIComponent(REMOTE_ROW_ID)}&select=meetings&limit=1&${cacheBuster}`;
					const res = await fetch(url, {
						cache: 'no-store',
						headers: {
							apikey: REMOTE_ANON_KEY,
							Authorization: `Bearer ${REMOTE_ANON_KEY}`,
						},
					});
					if (!res.ok) throw new Error(`Remote load failed: ${res.status}`);
					const rows = await res.json();
					const next = rows?.[0]?.meetings;
					if (!Array.isArray(next)) return null;
					try {
						localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
					} catch {}
					return next;
				} catch (err) {
					console.warn('[ship] remote load failed', err);
					return null;
				}
			}

			function parseMinutes(text) {
				const m = String(text || '').match(/(\d+)/);
				return m ? Number(m[1]) : NaN;
			}

			function timeToMinutes(hhmm) {
				const m = String(hhmm || '').trim().match(/^(\d{1,2}):(\d{2})$/);
				if (!m) return NaN;
				return Number(m[1]) * 60 + Number(m[2]);
			}

			function minutesToTime(total) {
				if (!Number.isFinite(total)) return '';
				const fixed = ((total % 1440) + 1440) % 1440;
				const h = String(Math.floor(fixed / 60)).padStart(2, '0');
				const m = String(fixed % 60).padStart(2, '0');
				return `${h}:${m}`;
			}

			function parseActualRange(value) {
				const raw = String(value || '').replaceAll('—', '-').replaceAll('–', '-');
				const parts = raw.split('-').map((p) => p.trim()).filter(Boolean);
				if (parts.length >= 2) {
					const start = timeToMinutes(parts[0]);
					const end = timeToMinutes(parts[1]);
					if (Number.isFinite(start) && Number.isFinite(end)) {
						return { start, end: end < start ? end + 24 * 60 : end };
					}
				}
				if (parts.length === 1) {
					const one = timeToMinutes(parts[0]);
					if (Number.isFinite(one)) return { start: one, end: one };
				}
				return null;
			}

			function computeAgenda(items, startTime) {
				const list = Array.isArray(items) ? items : [];
				let nextPlan = timeToMinutes(startTime || '19:15');
				if (!Number.isFinite(nextPlan)) nextPlan = timeToMinutes('19:15');
				return list.map((item, index) => {
					if (index > 0) {
						const prev = list[index - 1];
						const prevActual = parseActualRange(prev.actualTime);
						const prevDuration = parseMinutes(prev.duration || prev.planDuration || '');
						if (prevActual) nextPlan = prevActual.end + 1;
						else if (Number.isFinite(prevDuration)) nextPlan = nextPlan + prevDuration + 1;
					}
					const duration = parseMinutes(item.duration || item.planDuration || '');
					const actualRange = parseActualRange(item.actualTime);
					const actualDuration = actualRange ? actualRange.end - actualRange.start : NaN;
					let status = 'status-neutral';
					if (Number.isFinite(duration) && Number.isFinite(actualDuration)) {
						status = actualDuration <= duration ? 'status-green' : 'status-red';
					}
					return {
						...item,
						planTimeComputed: minutesToTime(nextPlan),
						durationComputed: Number.isFinite(duration) ? `${duration} min` : '-',
						actualTimeComputed: item.actualTime || 'TBD',
						status,
					};
				});
			}

			function renderMeetingCard(meeting) {
				const awards = (meeting.awards ?? [])
					.map(
						(item) => `
							<div class="award-item">
								<p>${escapeHtml(item.title)}</p>
								<strong>${escapeHtml(item.winner)}</strong>
							</div>
						`
					)
					.join('');

				const agenda = computeAgenda(meeting.agenda ?? [], meeting.agendaStartTime)
					.map(
						(item) => `
							<li class="agenda-item">
								<div class="agenda-time">
									<span>${escapeHtml(item.planTimeComputed)}</span>
								</div>
								<div class="agenda-duration">${escapeHtml(item.durationComputed)}</div>
								<div class="agenda-actual">${escapeHtml(item.actualTimeComputed)}</div>
								<div class="agenda-content">
									<h4>${escapeHtml(item.title)}</h4>
									<p>${escapeHtml(item.speaker)}</p>
								</div>
								<div class="agenda-dot ${item.status}"></div>
							</li>
						`
					)
					.join('');

				const imageNode = meeting.image
					? `<img src="${escapeHtml(meeting.image)}" alt="${escapeHtml(meeting.title)} cover" loading="lazy" />`
					: `<div class="thumb-placeholder">No Image</div>`;

				return `
					<details class="meeting-card">
						<summary>
							<div class="card-top">
								<div class="badges">
									<span class="badge type">${escapeHtml(meeting.type)}</span>
									<span class="badge id">${escapeHtml(meeting.id)}</span>
								</div>
								<svg class="chevron" viewBox="0 0 20 20" aria-hidden="true">
									<path d="m5 8 5 5 5-5"></path>
								</svg>
							</div>

							<div class="summary-head">
								<div class="summary-content">
									<h2>${escapeHtml(meeting.title)}</h2>
									<p class="manager">Managed by ${escapeHtml(meeting.manager)}</p>
									<div class="meta">
										<p><span class="meta-icon">&bull;</span>${escapeHtml(meeting.date)} | ${escapeHtml(meeting.time)}</p>
										<p><span class="meta-icon">&bull;</span>Word of Today: ${escapeHtml(meeting.wordOfToday || '-')}</p>
										<p><span class="meta-icon">&bull;</span>${escapeHtml(meeting.location)}</p>
									</div>
									<p class="description">${escapeHtml(meeting.description)}</p>
								</div>
								<div class="summary-thumb">${imageNode}</div>
							</div>

							<div class="awards">
								<h3>Awards</h3>
								<div class="awards-grid">${awards}</div>
							</div>
						</summary>
						<div class="expand-panel">
							<div class="switcher">
								<button class="active" type="button">Agenda</button>
								<button type="button">Table</button>
								<button type="button">Photos</button>
							</div>
							<ul class="agenda-list">${agenda}</ul>
						</div>
					</details>
				`;
			}

			async function render() {
				const target = document.getElementById('meeting-list');
				if (!target) return;
				let meetings = getMeetingsFromLocal();
				const remoteMeetings = await getMeetingsFromRemote();
				if (Array.isArray(remoteMeetings)) meetings = remoteMeetings;
				target.innerHTML = meetings.map(renderMeetingCard).join('');
			}

			render();
			window.addEventListener('storage', (evt) => {
				if (evt.key === STORAGE_KEY) render();
			});
			document.addEventListener('visibilitychange', () => {
				if (!document.hidden) render();
			});
		</script>
	</body>
</html>

<style is:global>
	.meeting-page {
		--blue-500: #0a84ff;
		--blue-600: #0066db;
		--line: rgba(10, 132, 255, 0.2);
		--text: #10223f;
		--muted: #5f728d;
		width: min(1160px, calc(100% - 2rem));
		margin: 0 auto;
		padding: 2.2rem 0 5rem;
		color: var(--text);
		font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
	}

	.hero {
		text-align: center;
		margin-bottom: 1.5rem;
	}
	.hero h1 {
		font-size: clamp(1.9rem, 2.8vw, 2.8rem);
		margin-bottom: 0.2rem;
	}
	.hero p {
		margin: 0;
		color: var(--muted);
	}

	.meeting-list {
		display: grid;
		gap: 1.2rem;
	}
	.meeting-card {
		background: rgba(255, 255, 255, 0.88);
		border: 1px solid var(--line);
		border-radius: 1rem;
		box-shadow: 0 10px 28px rgba(15, 35, 80, 0.08);
		overflow: clip;
	}
	.meeting-card > summary {
		list-style: none;
		cursor: pointer;
		padding: 1.25rem 1.5rem 1.4rem;
	}
	.meeting-card > summary::-webkit-details-marker {
		display: none;
	}

	.card-top {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 0.65rem;
	}
	.badges {
		display: inline-flex;
		gap: 0.45rem;
	}
	.badge {
		border-radius: 999px;
		padding: 0.22rem 0.72rem;
		font-weight: 700;
		font-size: 0.76rem;
	}
	.badge.type {
		background: linear-gradient(90deg, var(--blue-600), #5f6bff);
		color: #fff;
	}
	.badge.id {
		background: #f2ecff;
		color: #a34cff;
	}

	.chevron {
		width: 18px;
		height: 18px;
		stroke: #91a0b7;
		stroke-width: 2;
		fill: none;
		transition: transform 0.25s ease;
	}
	.meeting-card[open] .chevron {
		transform: rotate(180deg);
	}

	.summary-head {
		display: grid;
		grid-template-columns: minmax(0, 1fr) 128px;
		gap: 1rem;
		align-items: start;
	}
	h2 {
		font-size: clamp(1.45rem, 2vw, 2rem);
		margin: 0;
	}
	.manager {
		margin: 0.15rem 0 0.8rem;
		color: var(--muted);
	}
	.meta p {
		margin: 0 0 0.35rem;
		color: #5a6f8d;
	}
	.meta-icon {
		margin-right: 0.42rem;
	}
	.description {
		margin: 0.6rem 0 0;
		color: #4d627f;
		line-height: 1.65;
	}

	.summary-thumb {
		width: 128px;
		height: 228px;
		border-radius: 0.7rem;
		overflow: hidden;
		border: 1px solid rgba(10, 132, 255, 0.2);
		box-shadow: 0 6px 18px rgba(20, 55, 120, 0.12);
	}
	.summary-thumb img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}
	.thumb-placeholder {
		width: 100%;
		height: 100%;
		display: grid;
		place-items: center;
		background: linear-gradient(180deg, #eef4ff, #dce9ff);
		color: #5f728d;
		font-size: 0.74rem;
		font-weight: 600;
	}

	.awards {
		margin-top: 1rem;
		padding-top: 0.9rem;
		border-top: 1px dashed rgba(110, 130, 165, 0.32);
	}
	.awards h3 {
		margin: 0 0 0.65rem;
	}
	.awards-grid {
		display: grid;
		grid-template-columns: repeat(3, minmax(0, 1fr));
		gap: 0.85rem 1.1rem;
	}
	.award-item p {
		margin: 0;
		color: #4f6382;
	}
	.award-item strong {
		display: inline-block;
		margin-top: 0.15rem;
		color: #284cff;
	}

	.expand-panel {
		border-top: 1px solid rgba(10, 132, 255, 0.18);
		padding: 0.85rem 1.5rem 1.2rem;
	}
	.switcher {
		display: inline-flex;
		background: #f4f8ff;
		border: 1px solid var(--line);
		border-radius: 999px;
		padding: 0.2rem;
		gap: 0.15rem;
	}
	.switcher button {
		border: 0;
		background: transparent;
		padding: 0.33rem 0.7rem;
		border-radius: 999px;
		font-size: 0.76rem;
		color: #5d7597;
	}
	.switcher .active {
		background: #fff;
		color: #123e8a;
		box-shadow: 0 2px 8px rgba(18, 62, 138, 0.14);
	}

	.agenda-list {
		margin: 1rem 0 0;
		padding: 0;
		list-style: none;
		display: grid;
		gap: 0.65rem;
	}
	.agenda-item {
		display: grid;
		grid-template-columns: 76px 84px 130px minmax(0, 1fr) 12px;
		gap: 0.72rem;
		align-items: center;
	}
	.agenda-time span {
		display: block;
		font-size: 0.82rem;
		color: #1f57cc;
		font-weight: 700;
	}
	.agenda-duration,
	.agenda-actual {
		font-size: 0.8rem;
		color: #5f728e;
		white-space: nowrap;
	}
	.agenda-dot {
		width: 9px;
		height: 9px;
		border-radius: 999px;
		background: #9db0c9;
	}
	.status-green {
		background: #2ec37d;
	}
	.status-red {
		background: #ff5b67;
	}
	.agenda-content h4 {
		margin: 0;
	}
	.agenda-content p {
		margin: 0.12rem 0 0;
		font-size: 0.83rem;
		color: #5f728e;
	}
	@media (max-width: 900px) {
		.summary-head {
			grid-template-columns: minmax(0, 1fr) 104px;
		}
		.summary-thumb {
			width: 104px;
			height: 184.9px;
		}
		.awards-grid {
			grid-template-columns: repeat(2, minmax(0, 1fr));
		}
	}
	@media (max-width: 680px) {
		.meeting-page {
			width: calc(100% - 1rem);
			padding-top: 1.2rem;
		}
		.meeting-card > summary {
			padding: 1rem;
		}
		.expand-panel {
			padding: 0.7rem 1rem 1rem;
		}
		.summary-head {
			grid-template-columns: 1fr;
		}
		.summary-thumb {
			display: none;
		}
		.awards-grid {
			grid-template-columns: 1fr;
		}
		.agenda-item {
			grid-template-columns: 1fr;
			gap: 0.35rem;
			padding: 0.5rem 0.55rem;
			border: 1px solid rgba(10, 132, 255, 0.14);
			border-radius: 0.65rem;
		}
		.agenda-dot {
			display: none;
		}
	}
</style>
